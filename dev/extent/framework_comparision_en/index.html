<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Framework Comparision · HydroModels.jl</title><meta name="title" content="Framework Comparision · HydroModels.jl"/><meta property="og:title" content="Framework Comparision · HydroModels.jl"/><meta property="twitter:title" content="Framework Comparision · HydroModels.jl"/><meta name="description" content="Documentation for HydroModels.jl."/><meta property="og:description" content="Documentation for HydroModels.jl."/><meta property="twitter:description" content="Documentation for HydroModels.jl."/><meta property="og:url" content="https://chooron.github.io/HydroModels.jl/dev/extent/framework_comparision_en/"/><meta property="twitter:url" content="https://chooron.github.io/HydroModels.jl/dev/extent/framework_comparision_en/"/><link rel="canonical" href="https://chooron.github.io/HydroModels.jl/dev/extent/framework_comparision_en/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">HydroModels.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Run Models</span><ul><li><a class="tocitem" href="../../tutorials/run_exphydro_model/">Run ExpHydro Model</a></li></ul></li><li><a class="tocitem" href="../../concepts_en/">Basic Concepts</a></li><li><span class="tocitem">Model Implementations</span><ul><li><a class="tocitem" href="../../implements/build_exphydro_model_en/">construct the ExpHydro Model</a></li><li><a class="tocitem" href="../../implements/build_m50_model_en/">construct the M50 Model</a></li><li><a class="tocitem" href="../../implements/build_discharge_route_en/">construct the discharge route model</a></li></ul></li><li><span class="tocitem">Extend Contents</span><ul><li><a class="tocitem" href="../why_not_MTK_en/">Why not using ModelingToolkit.jl directly</a></li><li class="is-active"><a class="tocitem" href>Framework Comparision</a><ul class="internal"><li><a class="tocitem" href="#[Superflexpy](https://github.com/dalmo1991/superflexPy/tree/master)"><span>Superflexpy</span></a></li><li><a class="tocitem" href="#[MARRMoT](https://github.com/wknoben/MARRMoT)"><span>MARRMoT</span></a></li><li><a class="tocitem" href="#HydroModels.jl"><span>HydroModels.jl</span></a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Extend Contents</a></li><li class="is-active"><a href>Framework Comparision</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Framework Comparision</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/chooron/HydroModels.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/chooron/HydroModels.jl/blob/main/docs/src/extent/framework_comparision_en.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Comparing-Programming-Styles-for-Custom-Models-in-superflexpy,-MARRMoT,-and-HydroModels.jl"><a class="docs-heading-anchor" href="#Comparing-Programming-Styles-for-Custom-Models-in-superflexpy,-MARRMoT,-and-HydroModels.jl">Comparing Programming Styles for Custom Models in superflexpy, MARRMoT, and HydroModels.jl</a><a id="Comparing-Programming-Styles-for-Custom-Models-in-superflexpy,-MARRMoT,-and-HydroModels.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Comparing-Programming-Styles-for-Custom-Models-in-superflexpy,-MARRMoT,-and-HydroModels.jl" title="Permalink"></a></h1><p>This content corresponds to Section 4.1 of the paper, where we discuss the differences in programming styles for custom model implementation across these three software libraries. Using the GR4J model implementation as an example, we compare the programming styles for customizing model computation formulas.</p><h2 id="[Superflexpy](https://github.com/dalmo1991/superflexPy/tree/master)"><a class="docs-heading-anchor" href="#[Superflexpy](https://github.com/dalmo1991/superflexPy/tree/master)"><a href="https://github.com/dalmo1991/superflexPy/tree/master">Superflexpy</a></a><a id="[Superflexpy](https://github.com/dalmo1991/superflexPy/tree/master)-1"></a><a class="docs-heading-anchor-permalink" href="#[Superflexpy](https://github.com/dalmo1991/superflexPy/tree/master)" title="Permalink"></a></h2><p>Superflexpy is a Python implementation based on the SUPERFLEX concept. For implementing hydrological model computations, this framework typically uses Python syntax to express model calculation formulas, as shown below.</p><pre><code class="language-python hljs">@staticmethod
def _flux_function_python(S, S0, ind, P, x1, alpha, beta, ni, PET, dt):
    if ind is None:
        return (
            [
                P * (1 - (S / x1) ** alpha), # Ps
                -PET * (2 * (S / x1) - (S / x1) ** alpha), # Evaporation
                -((x1 ** (1 - beta)) / ((beta - 1) * dt)) * (ni ** (beta - 1)) * (S**beta), # Perc
            ],
            0.0,
            S0 + P * (1 - (S / x1) ** alpha) * dt,
        )
    else:
        return (
            [
                P[ind] * (1 - (S / x1[ind]) ** alpha[ind]), # Ps
                -PET[ind] * (2 * (S / x1[ind]) - (S / x1[ind]) ** alpha[ind]), # Evaporation
                -((x1[ind] ** (1 - beta[ind])) / ((beta[ind] - 1) * dt[ind]))
                * (ni[ind] ** (beta[ind] - 1))
                * (S ** beta[ind]), # Perc
            ],
            0.0,
            S0 + P[ind] * (1 - (S / x1[ind]) ** alpha[ind]) * dt[ind],
            [
                -(P[ind] * alpha[ind] / x1[ind]) * ((S / x1[ind]) ** (alpha[ind] - 1)),
                -(PET[ind] / x1[ind]) * (2 - alpha[ind] * ((S / x1[ind]) ** (alpha[ind] - 1))),
                -beta[ind]
                * ((x1[ind] ** (1 - beta[ind])) / ((beta[ind] - 1) * dt[ind]))
                * (ni[ind] ** (beta[ind] - 1))
                * (S ** (beta[ind] - 1)),
            ],
        )

@staticmethod
@nb.jit(
    &quot;Tuple((UniTuple(f8, 3), f8, f8, UniTuple(f8, 3)))&quot;
    &quot;(optional(f8), f8, i4, f8[:], f8[:], f8[:], f8[:], f8[:], f8[:], f8[:])&quot;,
    nopython=True,
)
def _flux_function_numba(S, S0, ind, P, x1, alpha, beta, ni, PET, dt):
    return (
        (
            P[ind] * (1 - (S / x1[ind]) ** alpha[ind]),  # Ps
            -PET[ind] * (2 * (S / x1[ind]) - (S / x1[ind]) ** alpha[ind]),  # Evaporation
            -((x1[ind] ** (1 - beta[ind])) / ((beta[ind] - 1) * dt[ind]))
            * (ni[ind] ** (beta[ind] - 1))
            * (S ** beta[ind]),  # Perc
        ),
        0.0,
        S0 + P[ind] * (1 - (S / x1[ind]) ** alpha[ind]) * dt[ind],
        (
            -(P[ind] * alpha[ind] / x1[ind]) * ((S / x1[ind]) ** (alpha[ind] - 1)),
            -(PET[ind] / x1[ind]) * (2 - alpha[ind] * ((S / x1[ind]) ** (alpha[ind] - 1))),
            -beta[ind]
            * ((x1[ind] ** (1 - beta[ind])) / ((beta[ind] - 1) * dt[ind]))
            * (ni[ind] ** (beta[ind] - 1))
            * (S ** (beta[ind] - 1)),
        ),
    )</code></pre><p>As shown, when implementing the GR4J production module calculations <a href="https://github.com/dalmo1991/superflexPy/blob/master/superflexpy/implementation/elements/gr4j.py">origin code</a>, the superflexpy framework requires separate construction of numpy and numba computation code. The function must specify hydrological fluxes <code>Ps</code>, <code>Evaporation</code>, <code>Perc</code>, and state variable balance equations. This approach couples multiple computational process implementations in a single code block, resulting in reduced code reusability (only reusable at the module level) and increased code volume and redundancy.</p><h2 id="[MARRMoT](https://github.com/wknoben/MARRMoT)"><a class="docs-heading-anchor" href="#[MARRMoT](https://github.com/wknoben/MARRMoT)"><a href="https://github.com/wknoben/MARRMoT">MARRMoT</a></a><a id="[MARRMoT](https://github.com/wknoben/MARRMoT)-1"></a><a class="docs-heading-anchor-permalink" href="#[MARRMoT](https://github.com/wknoben/MARRMoT)" title="Permalink"></a></h2><p>MARRMoT is a hydrological modeling framework developed in MATLAB. This framework constructs model types separately based on different hydrological models, storing the calculation formulas and state change equations involved. The simplified implementation code for the GR4J model in this framework is shown below.</p><pre><code class="language-matlab hljs">function [dS, fluxes] = model_fun(obj, S)
    % definitions
    ...
    % fluxes functions
    flux_pn   = max(P-Ep,0);
    flux_en   = max(Ep-P,0);
    flux_ef   = P - flux_pn;
    flux_ps   = saturation_4(S1,x1,flux_pn);
    flux_es   = evap_11(S1,x1,flux_en);
    flux_perc = percolation_3(S1,x1);
    flux_q9   = route(.9.*(flux_pn - flux_ps + flux_perc), uh_q9);
    flux_q1   = route(.1.*(flux_pn - flux_ps + flux_perc), uh_q1);
    flux_fr   = recharge_2(3.5,S2,x3,x2);
    flux_fq   = flux_fr;
    flux_qr   = baseflow_3(S2,x3);
    flux_qt   = flux_qr + max(flux_q1 + flux_fq,0);
    % this flux is not included in original MARRMoT,
    % but it is useful to calculate the water balance
    flux_ex = flux_fr + max(flux_q1 + flux_fq,0) - flux_q1;      
    % stores ODEs
    dS1 = flux_ps - flux_es - flux_perc;
    dS2 = flux_q9 + flux_fr - flux_qr;
    % outputs
    dS = [dS1 dS2];
    fluxes = [flux_pn,   flux_en, flux_ef, flux_ps, flux_es,...
                flux_perc, flux_q9, flux_q1, flux_fr, flux_fq,...
                flux_qr,   flux_qt, flux_ex];
end</code></pre><p>As evident, the MARRMoT framework expresses each Flux calculation formula through functions, allowing users to directly call functions for calculations (according to provided documentation). This approach significantly simplifies code writing requirements compared to superflexpy. However, MARRMoT has poor support for module reusability and cannot be reused like superflexpy. Additionally, combining variable assignments, flux calculations, and state change equations in one function results in poor decoupling of computational content.</p><h2 id="HydroModels.jl"><a class="docs-heading-anchor" href="#HydroModels.jl">HydroModels.jl</a><a id="HydroModels.jl-1"></a><a class="docs-heading-anchor-permalink" href="#HydroModels.jl" title="Permalink"></a></h2><pre><code class="language-julia hljs">#* define the production store
prod_funcs = [
    HydroFlux([prcp, ep] =&gt; [pn, en], exprs=[prcp - min(prcp, ep), ep - min(prcp, ep)]),
    HydroFlux([pn, soilwater] =&gt; [ps], [x1], exprs=[max(0.0, pn * (1 - (soilwater / x1)^2))]),
    HydroFlux([en, soilwater] =&gt; [es], [x1], exprs=[en * (2 * soilwater / x1 - (soilwater / x1)^2)]),
    HydroFlux([soilwater] =&gt; [perc], [x1], exprs=[((x1)^(-4)) / 4 * ((4 / 9)^(4)) * (soilwater^5)]),
    HydroFlux([pn, ps, perc] =&gt; [pr], exprs=[pn - ps + perc]),
    HydroFlux([pr] =&gt; [slowflow, fastflow], exprs=[0.9 * pr, 0.1 * pr]),
]
prod_dfuncs = [StateFlux([ps] =&gt; [es, perc], soilwater)]
prod_ele = HydroBucket(name=:gr4j_prod, funcs=prod_funcs, dfuncs=prod_dfuncs)

#* uh function
uh_flux_1 = HydroModels.UnitHydrograph([slowflow] =&gt; [slowflow_routed], x4, uhfunc=HydroModels.UHFunction(:UH_1_HALF), solvetype=:SPARSE)
uh_flux_2 = HydroModels.UnitHydrograph([fastflow] =&gt; [fastflow_routed], x4, uhfunc=HydroModels.UHFunction(:UH_2_FULL), solvetype=:SPARSE)

#* define the routing store
rst_funcs = [
    HydroFlux([routingstore] =&gt; [exch], [x2, x3], exprs=[x2 * abs(routingstore / x3)^3.5]),
    HydroFlux([routingstore, slowflow, exch] =&gt; [routedflow], [x3], exprs=[x3^(-4) / 4 * (routingstore + slowflow + exch)^5]),
    HydroFlux([routedflow, fastflow_routed, exch] =&gt; [flow], exprs=[routedflow + max(fastflow_routed + exch, 0.0)]),
]
rst_dfuncs = [StateFlux([exch, slowflow] =&gt; [routedflow], routingstore)]
rst_ele = HydroBucket(name=:gr4j_rst, funcs=rst_funcs, dfuncs=rst_dfuncs)

gr4j_model = HydroModel(name=:gr4j, components=[prod_ele, uh_flux_1, uh_flux_2, rst_ele])</code></pre><p>Returning to the GR4J model implementation in HydroModels.jl framework, we sequentially define the production store, unit hydrograph, and routing store. In this process, the model can achieve reusability while maintaining variable correspondence. The construction process includes instantiation of classes such as HydroFlux, StateFlux, UnitHydrograph, HydroModel, and HydroBucket. Unlike the previous two frameworks that use functional construction, these class instantiations express calculation formulas through symbolic programming. After model construction, calculations are performed through input data and parameters, demonstrating a design philosophy that completely decouples model structure and formulas from parameters and data, achieving high reusability.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../why_not_MTK_en/">« Why not using ModelingToolkit.jl directly</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Tuesday 24 December 2024 15:27">Tuesday 24 December 2024</span>. Using Julia version 1.11.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
