<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Embedding Neural Networks in ExpHydro Model: Implementation of M50 Model · HydroModels.jl</title><meta name="title" content="Embedding Neural Networks in ExpHydro Model: Implementation of M50 Model · HydroModels.jl"/><meta property="og:title" content="Embedding Neural Networks in ExpHydro Model: Implementation of M50 Model · HydroModels.jl"/><meta property="twitter:title" content="Embedding Neural Networks in ExpHydro Model: Implementation of M50 Model · HydroModels.jl"/><meta name="description" content="Documentation for HydroModels.jl."/><meta property="og:description" content="Documentation for HydroModels.jl."/><meta property="twitter:description" content="Documentation for HydroModels.jl."/><meta property="og:url" content="https://chooron.github.io/HydroModels.jl/dev/implements/build_m50_model_zh/"/><meta property="twitter:url" content="https://chooron.github.io/HydroModels.jl/dev/implements/build_m50_model_zh/"/><link rel="canonical" href="https://chooron.github.io/HydroModels.jl/dev/implements/build_m50_model_zh/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">HydroModels.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Model Implementations</span><ul><li><a class="tocitem" href="../build_exphydro_model_en/">construct a ExpHydro Model</a></li><li><a class="tocitem" href="../build_m50_model_en/">construct a M50 Model</a></li></ul></li><li><span class="tocitem">Run Models</span><ul><li><a class="tocitem" href="../../tutorials/run_a_bucket/">Run a Bucket Model</a></li><li><a class="tocitem" href="../../tutorials/run_a_exphydro_model/">Run ExpHydro Model</a></li></ul></li><li><span class="tocitem">Extent Content</span><ul><li><a class="tocitem" href="../../extent/framework_comparision_en/">Modeling Framework Comparisons</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Embedding Neural Networks in ExpHydro Model: Implementation of M50 Model</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Embedding Neural Networks in ExpHydro Model: Implementation of M50 Model</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/chooron/HydroModels.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/chooron/HydroModels.jl/blob/main/docs/src/implements/build_m50_model_zh.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Embedding-Neural-Networks-in-ExpHydro-Model:-Implementation-of-[M50](https://hess.copernicus.org/articles/26/5085/2022/)-Model"><a class="docs-heading-anchor" href="#Embedding-Neural-Networks-in-ExpHydro-Model:-Implementation-of-[M50](https://hess.copernicus.org/articles/26/5085/2022/)-Model">Embedding Neural Networks in ExpHydro Model: Implementation of <a href="https://hess.copernicus.org/articles/26/5085/2022/">M50</a> Model</a><a id="Embedding-Neural-Networks-in-ExpHydro-Model:-Implementation-of-[M50](https://hess.copernicus.org/articles/26/5085/2022/)-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Embedding-Neural-Networks-in-ExpHydro-Model:-Implementation-of-[M50](https://hess.copernicus.org/articles/26/5085/2022/)-Model" title="Permalink"></a></h1><p><a href="https://github.com/marv-in">marv-in</a>在论文中提出了M50和M100两个模型,代码储存于<a href="https://github.com/marv-in/HydroNODE">HydroNODE</a>中,开创了神经网络嵌入水文模型的先河(重点在于实现神经网络替换了ExpHydro模型的计算公式,并参与到平衡方程的求解中),这个模型也是对该仓库的启蒙,我们发现当前模型编写仍存在一定难度,因此我们创建这个仓库的首要目的就是简化神经网络嵌入水文模型这个过程,下面我们将对比源代码与本仓库在M50和M100模型上的实现差异,为使用者展现出一种新的模型搭建方式.</p><h2 id="HydroNODE中M50的实现方法"><a class="docs-heading-anchor" href="#HydroNODE中M50的实现方法">HydroNODE中M50的实现方法</a><a id="HydroNODE中M50的实现方法-1"></a><a class="docs-heading-anchor-permalink" href="#HydroNODE中M50的实现方法" title="Permalink"></a></h2><p>首先我们展示了HydroNODE中M50和M100模型的实现:</p><pre><code class="language-julia hljs"># define the ODE problem
function NeuralODE_M50_core!(dS,S,p,t)

    Tmin, Tmax, Df = (p_bucket_precal...,)

    Lday = itp_Lday(t)
    P    = itp_P(t)
    T    = itp_T(t)

    g_ET = ann_ET([norm_S0(S[1]), norm_S1(S[2]), norm_T(T)],p[:p1]) #p[idcs_params_ann_ET])
    g_Q = ann_Q([norm_S1(S[2]), norm_P(P)],p[:p2]) #p[idcs_params_ann_Q])

    melting = M(S[1], T, Df, Tmax)
    dS[1] = Ps(P, T, Tmin) - melting
    dS[2] = Pr(P, T, Tmin) + melting - step_fct(S[2])*Lday*exp(g_ET[1])- step_fct(S[2])*exp(g_Q[1])

end
# build and solve ODE problem
prob = ODEProblem(NeuralODE_M50_core!, S_init, Float64.((t_out[1], maximum(t_out))), p)
sol = solve(prob, BS3(), dt=1.0, saveat=t_out, reltol=1e-3, abstol=1e-3, sensealg=BacksolveAdjoint(autojacvec=ZygoteVJP()))
# calculate Qout
P_interp = norm_P.(itp_P.(t_out))
S1_ = norm_S1.(sol[2,:])
Qout_ =  exp.(ann_Q(permutedims([S1_ P_interp]),p[:p2])[1,:])</code></pre><p>在HydroNODE的代码中可以看出,模型构建分为以下三个步骤:</p><ul><li>ODE函数的定义</li><li>ODE问题的构建与求解</li><li>以及根据求解的中间状态计算Qout</li></ul><p>这个代码的构建风格遵循了最标准的DifferentialEquations.jl库的风格,然而这个代码中需要手动搭建模型的计算公式(<code>M</code>,<code>Ps</code>,<code>Pr</code>)并与状态方程表达式组合在一起(<code>dS</code>),模型的耦合性极高,同时,为获取<code>Qout</code>等中间计算通量,还需要额外调用对应的计算公式,代码编写的繁琐性相对较高.</p><h2 id="HydroModels.jl中M50的实现方法"><a class="docs-heading-anchor" href="#HydroModels.jl中M50的实现方法">HydroModels.jl中M50的实现方法</a><a id="HydroModels.jl中M50的实现方法-1"></a><a class="docs-heading-anchor-permalink" href="#HydroModels.jl中M50的实现方法" title="Permalink"></a></h2><p>相比较普通的概念式水文模型,M50模型使用神经网络模型替换了水文通量的计算公式(<code>ET</code>和<code>Q</code>),这个神经网络相比普通的计算公式有着明显的差异,因此在HydroModels.jl中采用了<code>NeuralFlux</code>来表示神经网络, 用于ET和Q预测的NeuralFlux如下表示:</p><pre><code class="language-julia hljs"># define the ET NN and Q NN
ep_nn = Lux.Chain(
    Lux.Dense(3 =&gt; 16, tanh),
    Lux.Dense(16 =&gt; 16, leakyrelu),
    Lux.Dense(16 =&gt; 1, leakyrelu),
    name=:epnn
)
ep_nn_params = Vector(ComponentVector(first(Lux.setup(StableRNGs.LehmerRNG(1234), ep_nn))))
q_nn = Lux.Chain(
    Lux.Dense(2 =&gt; 16, tanh),
    Lux.Dense(16 =&gt; 16, leakyrelu),
    Lux.Dense(16 =&gt; 1, leakyrelu),
    name=:qnn
)
q_nn_params = Vector(ComponentVector(first(Lux.setup(StableRNGs.LehmerRNG(1234), q_nn))))


ep_nn_flux = NeuralFlux([norm_snw, norm_slw, norm_temp] =&gt; [log_evap_div_lday], ep_nn)
q_nn_flux = NeuralFlux([norm_slw, norm_prcp] =&gt; [log_flow], q_nn)</code></pre><p>构建M50模型相对特殊的一点在于需要针对嵌入的神经网络使用NeuralFlux模型进行包装,为神经网络赋予输入输出的信息,并在构建过程中将神经网络转换为表达式.</p><p>然后我们可以构建M50模型的其余部分:</p><pre><code class="language-julia hljs"># define the snow pack reservoir
snow_funcs = [
    HydroFlux([temp, lday] =&gt; [pet], exprs=[29.8 * lday * 24 * 0.611 * exp((17.3 * temp) / (temp + 237.3)) / (temp + 273.2)]),
    HydroFlux([prcp, temp] =&gt; [snowfall, rainfall], [Tmin], exprs=[step_func(Tmin - temp) * prcp, step_func(temp - Tmin) * prcp]),
    HydroFlux([snowpack, temp] =&gt; [melt], [Tmax, Df], exprs=[step_func(temp - Tmax) * min(snowpack, Df * (temp - Tmax))]),
]
snow_dfuncs = [StateFlux([snowfall] =&gt; [melt], snowpack)]
snow_ele = HydroBucket(name=:exphydro_snow, funcs=snow_funcs, dfuncs=snow_dfuncs)

# define the soil water reservoir
soil_funcs = [
    #* normalize
    HydroFlux([snowpack, soilwater, prcp, temp] =&gt; [norm_snw, norm_slw, norm_prcp, norm_temp],
        [snowpack_mean, soilwater_mean, prcp_mean, temp_mean, snowpack_std, soilwater_std, prcp_std, temp_std],
        exprs=[(var - mean) / std for (var, mean, std) in zip([snowpack, soilwater, prcp, temp],
            [snowpack_mean, soilwater_mean, prcp_mean, temp_mean],
            [snowpack_std, soilwater_std, prcp_std, temp_std]
        )]),
    ep_nn_flux,
    q_nn_flux
]
state_expr = rainfall + melt - step_func(soilwater) * lday * exp(log_evap_div_lday) - step_func(soilwater) * exp(log_flow)
soil_dfuncs = [StateFlux([soilwater, rainfall, melt, lday, log_evap_div_lday, log_flow], soilwater, Num[], expr=state_expr)]
soil_ele = HydroBucket(name=:m50_soil, funcs=soil_funcs, dfuncs=soil_dfuncs)
convert_flux = HydroFlux([log_flow] =&gt; [flow], exprs=[exp(log_flow)])
# define the Exp-Hydro model
m50_model = HydroModel(name=:m50, components=[snow_ele, soil_ele, convert_flux]);</code></pre><p>上述代码中我们对M50模型进行了一个完整的表现,首先包括ExpHydro中Snowpack Bucket的实现,其次就是对于神经网络嵌入后Soilwater Bucket的实现. 在Soilwater Bucket模块实现中,可以通过定义的NeuralFlux(<code>ep_nn_flux</code>和<code>q_nn_flux</code>)来表达嵌入的神经网络,并与其他<code>HydroFlux</code>进行组合,结合<code>StateFlux</code>构建Soilwater Bucket.</p></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Wednesday 11 December 2024 02:12">Wednesday 11 December 2024</span>. Using Julia version 1.11.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
