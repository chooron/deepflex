<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>construct the M50 Model · HydroModels.jl</title><meta name="title" content="construct the M50 Model · HydroModels.jl"/><meta property="og:title" content="construct the M50 Model · HydroModels.jl"/><meta property="twitter:title" content="construct the M50 Model · HydroModels.jl"/><meta name="description" content="Documentation for HydroModels.jl."/><meta property="og:description" content="Documentation for HydroModels.jl."/><meta property="twitter:description" content="Documentation for HydroModels.jl."/><meta property="og:url" content="https://chooron.github.io/HydroModels.jl/dev/implements/build_m50_model_en/"/><meta property="twitter:url" content="https://chooron.github.io/HydroModels.jl/dev/implements/build_m50_model_en/"/><link rel="canonical" href="https://chooron.github.io/HydroModels.jl/dev/implements/build_m50_model_en/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">HydroModels.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Run Models</span><ul><li><a class="tocitem" href="../../tutorials/run_exphydro_model/">Run ExpHydro Model</a></li></ul></li><li><a class="tocitem" href="../../concepts_en/">Basic Concepts</a></li><li><span class="tocitem">Model Implementations</span><ul><li><a class="tocitem" href="../build_exphydro_model_en/">construct the ExpHydro Model</a></li><li class="is-active"><a class="tocitem" href>construct the M50 Model</a><ul class="internal"><li><a class="tocitem" href="#M50-Implementation-in-HydroNODE"><span>M50 Implementation in HydroNODE</span></a></li><li><a class="tocitem" href="#M50-Implementation-in-HydroModels.jl"><span>M50 Implementation in HydroModels.jl</span></a></li></ul></li><li><a class="tocitem" href="../build_discharge_route_en/">construct the discharge route model</a></li></ul></li><li><span class="tocitem">Extend Contents</span><ul><li><a class="tocitem" href="../../extent/why_not_MTK_en/">Why not using ModelingToolkit.jl directly</a></li><li><a class="tocitem" href="../../extent/framework_comparision_en/">Framework Comparision</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Model Implementations</a></li><li class="is-active"><a href>construct the M50 Model</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>construct the M50 Model</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/chooron/HydroModels.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/chooron/HydroModels.jl/blob/main/docs/src/implements/build_m50_model_en.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Embedding-Neural-Networks-in-ExpHydro-Model:-Implementation-of-[M50](https://hess.copernicus.org/articles/26/5085/2022/)-Model"><a class="docs-heading-anchor" href="#Embedding-Neural-Networks-in-ExpHydro-Model:-Implementation-of-[M50](https://hess.copernicus.org/articles/26/5085/2022/)-Model">Embedding Neural Networks in ExpHydro Model: Implementation of <a href="https://hess.copernicus.org/articles/26/5085/2022/">M50</a> Model</a><a id="Embedding-Neural-Networks-in-ExpHydro-Model:-Implementation-of-[M50](https://hess.copernicus.org/articles/26/5085/2022/)-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Embedding-Neural-Networks-in-ExpHydro-Model:-Implementation-of-[M50](https://hess.copernicus.org/articles/26/5085/2022/)-Model" title="Permalink"></a></h1><p><a href="https://github.com/marv-in">marv-in</a> proposed the M50 and M100 models in their paper, with code stored in <a href="https://github.com/marv-in/HydroNODE">HydroNODE</a>, pioneering the integration of neural networks into hydrological models (notably by replacing ExpHydro model&#39;s calculation formulas while participating in balance equation solving). This model inspired our repository, and recognizing the current complexity in model development, our primary goal is to simplify the process of embedding neural networks into hydrological models. Below, we&#39;ll compare the source code with our repository&#39;s implementation of M50 and M100 models, showcasing a new approach to model construction.</p><h2 id="M50-Implementation-in-HydroNODE"><a class="docs-heading-anchor" href="#M50-Implementation-in-HydroNODE">M50 Implementation in HydroNODE</a><a id="M50-Implementation-in-HydroNODE-1"></a><a class="docs-heading-anchor-permalink" href="#M50-Implementation-in-HydroNODE" title="Permalink"></a></h2><p>First, let&#39;s examine the implementation of M50 and M100 models in HydroNODE:</p><pre><code class="language-julia hljs"># define the ODE problem
function NeuralODE_M50_core!(dS,S,p,t)

    Tmin, Tmax, Df = (p_bucket_precal...,)

    Lday = itp_Lday(t)
    P    = itp_P(t)
    T    = itp_T(t)

    g_ET = ann_ET([norm_S0(S[1]), norm_S1(S[2]), norm_T(T)],p[:p1]) #p[idcs_params_ann_ET])
    g_Q = ann_Q([norm_S1(S[2]), norm_P(P)],p[:p2]) #p[idcs_params_ann_Q])

    melting = M(S[1], T, Df, Tmax)
    dS[1] = Ps(P, T, Tmin) - melting
    dS[2] = Pr(P, T, Tmin) + melting - step_fct(S[2])*Lday*exp(g_ET[1])- step_fct(S[2])*exp(g_Q[1])

end
# build and solve ODE problem
prob = ODEProblem(NeuralODE_M50_core!, S_init, Float64.((t_out[1], maximum(t_out))), p)
sol = solve(prob, BS3(), dt=1.0, saveat=t_out, reltol=1e-3, abstol=1e-3, sensealg=BacksolveAdjoint(autojacvec=ZygoteVJP()))
# calculate Qout
P_interp = norm_P.(itp_P.(t_out))
S1_ = norm_S1.(sol[2,:])
Qout_ =  exp.(ann_Q(permutedims([S1_ P_interp]),p[:p2])[1,:])</code></pre><p>In the HydroNODE code, we can see that model construction consists of three steps:</p><ul><li>ODE function definition</li><li>ODE problem construction and solution</li><li>Calculation of Qout from intermediate states</li></ul><p>While this code follows the standard style of the DifferentialEquations.jl library, it requires manual construction of model calculation formulas (<code>M</code>, <code>Ps</code>, <code>Pr</code>) and their combination with state equation expressions (<code>dS</code>). The model has high coupling, and obtaining intermediate calculation fluxes like <code>Qout</code> requires additional calls to corresponding calculation formulas, making the code relatively complex to write.</p><h2 id="M50-Implementation-in-HydroModels.jl"><a class="docs-heading-anchor" href="#M50-Implementation-in-HydroModels.jl">M50 Implementation in HydroModels.jl</a><a id="M50-Implementation-in-HydroModels.jl-1"></a><a class="docs-heading-anchor-permalink" href="#M50-Implementation-in-HydroModels.jl" title="Permalink"></a></h2><p>First, we need to define the parameters and variables designed in the M50 model:</p><pre><code class="language-julia hljs">using HydroModels

#! parameters in the Exp-Hydro model
@parameters Tmin Tmax Df Smax f Qmax
#! parameters in normalize flux
@parameters snowpack_std snowpack_mean
@parameters soilwater_std soilwater_mean
@parameters prcp_std prcp_mean
@parameters temp_std temp_mean

#! hydrological flux in the Exp-Hydro model
@variables prcp temp lday pet rainfall snowfall
@variables snowpack soilwater lday pet
@variables melt log_evap_div_lday log_flow flow
@variables norm_snw norm_slw norm_temp norm_prcp

step_func(x) = (tanh(5.0 * x) + 1.0) * 0.5</code></pre><p>Compared to conventional conceptual hydrological models, the M50 model uses neural networks to replace hydrological flux calculation formulas (<code>ET</code> and <code>Q</code>). These neural networks differ significantly from standard calculation formulas, so HydroModels.jl uses <code>NeuralFlux</code> to represent neural networks. The NeuralFlux for ET and Q predictions is shown below:</p><pre><code class="language-julia hljs">using Lux
using StableRNGs

# define the ET NN and Q NN
ep_nn = Lux.Chain(
    Lux.Dense(3 =&gt; 16, tanh),
    Lux.Dense(16 =&gt; 16, leakyrelu),
    Lux.Dense(16 =&gt; 1, leakyrelu),
    name=:epnn
)
ep_nn_params = Vector(ComponentVector(first(Lux.setup(StableRNGs.LehmerRNG(1234), ep_nn))))
q_nn = Lux.Chain(
    Lux.Dense(2 =&gt; 16, tanh),
    Lux.Dense(16 =&gt; 16, leakyrelu),
    Lux.Dense(16 =&gt; 1, leakyrelu),
    name=:qnn
)
q_nn_params = Vector(ComponentVector(first(Lux.setup(StableRNGs.LehmerRNG(1234), q_nn))))


ep_nn_flux = NeuralFlux([norm_snw, norm_slw, norm_temp] =&gt; [log_evap_div_lday], ep_nn)
q_nn_flux = NeuralFlux([norm_slw, norm_prcp] =&gt; [log_flow], q_nn)</code></pre><p>A special aspect of building the M50 model is the need to wrap embedded neural networks using the NeuralFlux model, providing input-output information for the neural networks and converting them into expressions during construction.</p><p>Then we can build the remaining parts of the M50 model:</p><pre><code class="language-julia hljs"># define the snow pack reservoir
snow_funcs = [
    HydroFlux([temp, lday] =&gt; [pet], exprs=[29.8 * lday * 24 * 0.611 * exp((17.3 * temp) / (temp + 237.3)) / (temp + 273.2)]),
    HydroFlux([prcp, temp] =&gt; [snowfall, rainfall], [Tmin], exprs=[step_func(Tmin - temp) * prcp, step_func(temp - Tmin) * prcp]),
    HydroFlux([snowpack, temp] =&gt; [melt], [Tmax, Df], exprs=[step_func(temp - Tmax) * min(snowpack, Df * (temp - Tmax))]),
]
snow_dfuncs = [StateFlux([snowfall] =&gt; [melt], snowpack)]
snow_ele = HydroBucket(name=:exphydro_snow, funcs=snow_funcs, dfuncs=snow_dfuncs)

# define the soil water reservoir
soil_funcs = [
    #* normalize
    HydroFlux([snowpack, soilwater, prcp, temp] =&gt; [norm_snw, norm_slw, norm_prcp, norm_temp],
        [snowpack_mean, soilwater_mean, prcp_mean, temp_mean, snowpack_std, soilwater_std, prcp_std, temp_std],
        exprs=[(var - mean) / std for (var, mean, std) in zip([snowpack, soilwater, prcp, temp],
            [snowpack_mean, soilwater_mean, prcp_mean, temp_mean],
            [snowpack_std, soilwater_std, prcp_std, temp_std]
        )]),
    ep_nn_flux,
    q_nn_flux
]
state_expr = rainfall + melt - step_func(soilwater) * lday * exp(log_evap_div_lday) - step_func(soilwater) * exp(log_flow)
soil_dfuncs = [StateFlux([soilwater, rainfall, melt, lday, log_evap_div_lday, log_flow], soilwater, expr=state_expr)]
soil_ele = HydroBucket(name=:m50_soil, funcs=soil_funcs, dfuncs=soil_dfuncs)
convert_flux = HydroFlux([log_flow] =&gt; [flow], exprs=[exp(log_flow)])
# define the Exp-Hydro model
m50_model = HydroModel(name=:m50, components=[snow_ele, soil_ele, convert_flux]);</code></pre><p>In the code above, we present a complete implementation of the M50 model, starting with the Snowpack Bucket implementation from ExpHydro, followed by the Soilwater Bucket implementation with neural network embedding. In the Soilwater Bucket module implementation, we can use defined NeuralFlux (<code>ep_nn_flux</code> and <code>q_nn_flux</code>) to express embedded neural networks, combining them with other <code>HydroFlux</code> components and using <code>StateFlux</code> to construct the Soilwater Bucket.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../build_exphydro_model_en/">« construct the ExpHydro Model</a><a class="docs-footer-nextpage" href="../build_discharge_route_en/">construct the discharge route model »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Friday 20 December 2024 12:33">Friday 20 December 2024</span>. Using Julia version 1.11.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
